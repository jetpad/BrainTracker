"use strict";var myApp=angular.module("myApp",["ui.bootstrap","ngTable","angular-gestures","ngRoute"]);myApp.directive("onReadFile",["$parse",function(){return{restrict:"A",scope:{onReadFile:"&"},link:function(a,b){b.on("change",function(b){var c=new FileReader;c.onload=function(b){a.$apply(function(){a.onReadFile({$content:b.target.result})})},c.readAsText((b.srcElement||b.target).files[0])})}}}]),myApp.config(["$routeProvider","$locationProvider",function(a){a.when("/",{templateUrl:"views/main.html"}).when("/contact",{templateUrl:"views/contact.html"}).when("/about",{templateUrl:"views/about.html"}).when("/import",{templateUrl:"views/import.html"}).when("/report",{templateUrl:"views/session-report.html",controller:"SessionsReportControl"}).when("/chart",{templateUrl:"views/sessions-chart.html",controller:"SessionsChartControl"}).when("/testreport",{templateUrl:"views/testreport.html"}).when("/signout",{templateUrl:"views/signout.html"}).when("/results",{templateUrl:"views/results.html"}).when("/test",{templateUrl:"views/reaction-number.html"}).when("/testcomplete",{templateUrl:"views/test-complete.html"}).otherwise({redirectTo:"/"})}]),myApp.service("dbService",["$location","$q","safeApply","$rootScope","$timeout",function(a,b,c,d,e){function f(a,b){return function(e,f){c(d,function(){e?(console.log('dbService "'+b+'" returned error',e),a.reject(e)):(console.log('dbService "'+b+'" returned successfully',f),a.resolve(f))})}}var g,h=null,i=null,j=null,k=null,l=this,m=null;this.initialize=function(){return g=new Dropbox.Client({key:"46tjf8x15q98xic"}),console.log("Initialize"),l.authenticate({interactive:!1})},this.sessions=function(){return m},this.isAuthenticated=function(){return g.isAuthenticated()},this.isDatastoreOpen=function(){return!(null===h)},this.getDatastore=function(){return h},this.deleteDatastore=function(a){var c=b.defer();return i.deleteDatastore(a,f(c,"deleteDatastore")),c.promise},this.createDatastore=function(){var a=b.defer();return i.createDatastore(function(b,e){c(d,function(){b?(console.log("Error creating datastore: "+b),a.reject(b)):(console.log("successfully created new datastore"),h=e,l.openTables(),a.resolve(e))})}),a.promise},this.listDatastores=function(){var a=b.defer();return i.listDatastores(function(b,e){c(d,function(){b?(console.log("Error opening default datastore: "+b),a.reject(b)):a.resolve(e)})}),a.promise},this.openDatastore=function(a){var e=b.defer();return l.isDatastoreOpen()&&h.getId()==a?(e.resolve(h),e.promise):(i.openDatastore(a,function(a,b){c(d,function(){a?(console.log("Error opening default datastore: "+a),e.reject(a)):(h=b,l.openTables(),e.resolve(b))})}),e.promise)},this.openDefaultDatastore=function(){var a=b.defer();if(this.isDatastoreOpen()&&"default"==h.getId())return a.resolve(h),a.promise;var e=(new Date).getTime();return i.openDefaultDatastore(function(b,f){c(d,function(){if(b)console.log("Error opening default datastore: "+b),a.reject(b);else{console.log("successfully opened default datastore");var c=(new Date).getTime();console.log("Time to get datastore: ",c-e," (ms)"),h=f,l.openTables(),a.resolve(f)}})}),a.promise},this.authenticate=function(a){var e=b.defer();return l.ready()?(e.resolve(h),e.promise):(g.authenticate(a,function(a){c(d,function(){a?(console.log("Authentication error: "+a),e.reject(a)):g.isAuthenticated()?(i=g.getDatastoreManager(),l.openDefaultDatastore(h).then(function(a){console.log("authenticate success"),e.resolve(a)},function(a){console.log("Error opening default datastore: "+a),e.reject(a)})):e.reject()})}),e.promise)},this.openTables=function(){j=h.getTable("session");var a=(new Date).getTime(),b=j.query(),c=(new Date).getTime();console.log("sessions elapsed time: ",c-a),m=l.sessionToObjectArray(b),d.$broadcast("sessionDataChanged"),l.subscribeRecordsChanged(function(a){console.log("a session record has changed: ",a.length),m=m.concat(l.sessionToObjectArray(a)),d.$broadcast("sessionDataChanged")},"session")},this.ready=function(){return j&&Dropbox.Datastore.Table.isValidId(j.getId())?!0:!1},this.sessionRecordCount=function(){return null===j?0:m.length},this.close=function(){i&&i.close()};var n=function(a){return function(b){c(d,function(){a(b)})}};this.subscribeRecordsChanged=function(a,b){var c=function(){};return c=n(b?function(c){var d=c.affectedRecordsForTable(b);a(d)}:a),h.recordsChanged.addListener(c),c},this.sessionToObjectArray=function(a){for(var b=gauss.Vector,c=[],d=(new Date).getTime(),e=0;e<a.length;e++){for(var f=a[e].getFields(),g=f.trials.toArray(),h=new b,i=0;i<g.length;i++)h.push(JSON.parse(g[i]));f.trials=h,c.push(f)}var j=(new Date).getTime();return console.log("convert to array elapsed time: ",j-d),c},this.addSessions=function(a){console.log("Adding sessions");for(var b=0;b<a.length;b++)l.addSession(a[b]);console.log("Finished adding sessions")},this.backgroundAddSessions=function(a){function c(){e(function(){console.log("Processing a session:",f),l.addSession(a[f]),d.notify({idx:f,max:a.length}),f++,f<a.length?c():(console.log("Finished background adding of sessions"),d.resolve({idx:f,max:a.length}))},0)}console.log("Started background adding of sessions");var d=b.defer(),f=0;return c(),d.promise},this.addTrials=function(a,b){for(var c=0;c<b.length;c++)l.addTrial(a,b[c])},this.addTrial=function(a,b){var c=k.insert({sessionid:a,problem:b.problem,answer:b.answer,latency:b.latency,latencyptile:b.latencyptile,include:b.include,correct:b.correct,warmup:b.warmup,correction:b.correction});return c},this.addSession=function(a){console.log("session:",a),a.latency=Math.round(a.trials.find({n:!0}).map(function(a){return a.l}).mean()),console.log("latency: ",a.latency);for(var b=[],c=0;c<a.trials.length;c++)b.push(JSON.stringify(a.trials[c]));if(isNaN(a.latency))return null;var d=j.insert({notes:a.notes,starttime:a.starttime,endtime:a.endtime,latency:a.latency,minlatency:a.minlatency,maxlatency:a.maxlatency,testtype:a.testtype,testversion:a.testversion,delay:a.delay,duration:a.duration,trials:b});return d},this.authenticatedNavigate=function(b){1==this.isAuthenticated()?a.path(b):(g.reset(),this.authenticate({interactive:!0}).then(function(){console.log("authenticated successs")},function(a){console.log("error authenticating({interactive: true}): "+a),this.initialize()}))},this.signout=function(){h=null,0==this.isAuthenticated()?(console.log("not authenticated, signing out"),a.path("/signout")):(new function(){var c=b.defer();return j=null,a.path("/signout"),g.signOut({mustInvalidate:!0},f(c,"signOut")),c.promise}).then(function(){console.log("signing out")},function(){console.log("Error signing out")})},this.CSVToArray=function(a,b){b=b||",";for(var c=new RegExp("(\\"+b+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+b+"\\r\\n]*))","gi"),d=[[]],e=null;e=c.exec(a);){var f=e[1];if(f.length&&f!=b&&d.push([]),e[2])var g=e[2].replace(new RegExp('""',"g"),'"');else var g=e[3];d[d.length-1].push(g)}return d},this.parseTrialstoSessions=function(a){for(var b,c=[],d={},e={},f=gauss.Vector,g=1;g<a.length-1;g++){var h=a[g];h[2]!=b&&(b=h[2],1!=g&&c.push(d),d={},d.notes=b.substr(17),d.starttime=this.parseDateFromR(h[1]),d.minlatency=150,d.maxlatency=3e3,d.testtype="SETH",d.testversion=1,d.delay=Math.round(h[4]),d.trials=new f),d.endtime=this.parseDateFromR(h[1]),d.duration=Math.round((d.endtime-d.starttime)/1e3),e={},e.p=h[5],e.a=h[8],e.l=Math.round(h[6]),"TRUE"==h[10]&&(e.n=!0),"TRUE"==h[9]&&(e.c=!0),"warmup"==h[11]&&(e.w=!0),"correction trial"==h[11]&&(e.x=!0),d.trials.push(e)}return c.push(d),c},this.parseDateFromR=function(a){var b=/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})(.*)/,c=a.match(b);return new Date(Number(c[1]),Number(c[2]-1),Number(c[3]),Number(c[4]),Number(c[5]),Number(c[6]))}}]),myApp.factory("safeApply",[function(){return function(a,b){var c=a.$root.$$phase;"$apply"==c||"$digest"==c?b&&a.$eval(b):b?a.$apply(b):a.$apply()}}]),myApp.controller("MainCtrl",["$scope","$rootScope","$q","$http","$location","dbService",function(a,b,c,d,e,f){if(console.log("protocol: ",e.protocol()),console.log("host: ",e.host()),"http"==e.protocol()&&"localhost"!=e.host()){var g="https:"+e.absUrl().substr(5);console.log("new URL: ",g),window.location=g}a.dbService=f,f.initialize().then(function(){}),a.displayMessage=function(a){$window.alert(a)},a.importCSV=function(){var b=f.CSVToArray(a.content),c=f.parseTrialstoSessions(b);f.backgroundAddSessions(c).then(function(b){a.importIndex=b.idx,a.importMax=b.max},function(){},function(b){a.importIndex=b.idx,a.importMax=b.max})},a.showContent=function(b){a.content=b;{var c=f.CSVToArray(a.content);f.parseTrialstoSessions(c)}}}]),myApp.controller("DemoCtrl",["$scope","$rootScope","$filter","ngTableParams",function(a,b,c,d){a.datasets=["1","2"],a.dataset="2";var e=[{notes:"One",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Two",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Three",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Four",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Five",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Six",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Seven",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Eight",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Nine",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Ten",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Eleven",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Twelve",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Thirteen",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Fourteen",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Fifteen",starttime:"2014-01-23T22:13:18.000Z"},{notes:"Sixteen",starttime:"2014-01-23T22:13:18.000Z"}],f=function(){return"1"===a.dataset?e:a.sessions};a.$watch("dataset",function(){a.tableParams.reload()}),a.$watch("dbReady",function(){a.tableParams.reload()}),a.tableParams=new d({pstarttime:1,count:10,sorting:{notes:"asc"}},{total:function(){return f().length},getData:function(a,b){var d=f(),e=b.sorting()?c("orderBy")(d,b.orderBy()):d;b.total(e.length),a.resolve(e.slice((b.page()-1)*b.count(),b.page()*b.count()))},$scope:{$data:{}}})}]),myApp.controller("SessionsReportControl",["$scope","$rootScope","$filter","$timeout","$q","$http","$location","safeApply","ngTableParams","dbService",function(a,b,c,d,e,f,g,h,i){a.$on("sessionDataChanged",function(){console.log("Updating Report"),a.tableParams.reload()});var j=function(){return a.dbService.sessions()?a.dbService.sessions():[]};a.tableParams=new i({page:1,count:10,sorting:{name:"asc"}},{total:function(){return j().length},getData:function(a,b){var d=j(),e=b.sorting()?c("orderBy")(d,b.orderBy()):d;b.total(e.length),a.resolve(e.slice((b.page()-1)*b.count(),b.page()*b.count()))},$scope:{$data:{}}})}]),myApp.controller("SessionsChartControl",["$scope","$rootScope","$filter","$timeout","$q","$http","$location","safeApply","ngTableParams","dbService",function(a,b,c){var d=this;this.getData=function(){var b=a.dbService.sessions()?a.dbService.sessions():[],c=[];0==b.length&&(c=[{x:0,y:0}]);for(var d=0;d<b.length;d++)c.push({x:b[d].starttime.getTime()/1e3,y:b[d].latency});return c};var e=new Rickshaw.Graph({element:document.querySelector("#chart"),width:800,height:400,renderer:"scatterplot",stroke:!0,padding:{top:.05,left:.05,right:.05},preserve:!0,series:[{name:"",data:this.getData(),color:"steelblue"}]}),f=new Rickshaw.Graph.Axis.Time({graph:e}),g=new Rickshaw.Graph.Axis.Y({graph:e,orientation:"right",tickFormat:Rickshaw.Fixtures.Number.formatKMBT}),h=(new Rickshaw.Graph.HoverDetail({graph:e,xFormatter:function(){return null},formatter:function(a,b,d){var e='<span class="date">'+c("date")(1e3*b,"medium")+"</span>",f='<span class="detail_swatch" style="background-color: '+a.color+'"></span>',g=f+a.name+" "+parseInt(d)+" (ms)<br>"+e;return g}}),new Rickshaw.Graph.RangeSlider.Preview({graph:e,padding:{left:40},renderer:"scatterplot",element:document.querySelector("#preview")})),i="glow",j=new Rickshaw.Graph.Axis.Time({graph:h.previews[0],timeFixture:new Rickshaw.Fixtures.Time.Local,ticksTreatment:i});j.render(),e.configure({renderer:"scatterplot"}),e.render(),a.$on("sessionDataChanged",function(){console.log("Updating Chart"),e.series[0].data=d.getData(),f.render(),g.render(),e.render()})}]),myApp.factory("ReactionTimeTrial",["$timeout",function(a){var b;return b=function(){function b(){var b=this;this.starttime=new Date,this.minimumtime=100,this.maximumtime=2e3,this.phase="waiting",this.correction=!1,this.delay=1500,a.cancel(this.delayPromise),this.delayPromise=a(function(){return b.enterGoPhase()},this.delay)}return b.prototype.enterGoPhase=function(){if(!this.problem){var a=["2","3","4","5","6","7","8"];this.problem=a[Math.floor(Math.random()*a.length)]}return this.phase="go",this.starttime=new Date,this.starttime},b.prototype.reactionClick=function(){switch(a.cancel(this.delayPromise),this.endtime=new Date,this.latency=this.endtime-this.starttime,this.phase="result",this.starttime||(this.phase="too-fast"),this.endtime-this.starttime<this.minimumtime&&(this.phase="too-fast"),this.endtime-this.starttime>this.maximumtime&&(this.phase="too-slow"),this.answer!=this.problem&&(console.log("wrong-number!!!"),this.phase="wrong-number"),this.phase){case"too-fast":this.correct=!1;break;case"too-slow":this.correct=!1;break;case"wrong-number":this.correct=!1;break;default:console.log("Correct!"),this.correct=!0,0==this.warmup&&0==this.correction&&(this.include=!0)}return this.latency},b}()}]).factory("ReactionTimeSession",["ReactionTimeTrial","$http","$location","dbService",function(a,b,c,d){var e;return e=function(){function b(){this.initialize()}return b.prototype.initialize=function(){this.trials=[],this.currentTrial=null,this.correctionTrial=!1,this.warmup=!1,this.maxTrials=32},b.prototype.start=function(){return this.nextTrial()},b.prototype.nextTrial=function(){var b=new a(this);return 1==this.correctionTrial&&(b.problem=this.currentTrial.problem,b.correction=!0),b.include=1==this.warmup||1==this.correctionTrial?!1:!0,0==b.include&&console.log("NOT INCLUDING the _nextTrial"),this.currentTrial=b},b.prototype.clickedNumber=function(a){switch(this.currentTrial&&(this.currentTrial.answer=a?a:String.fromCharCode(event.keyCode)),this.getValidTrials()>=this.getMaxTrials()&&(this.saveSession(),console.log("test complete"),c.path("/testcomplete")),this.getView()){case"splash":this.start();break;case"waiting":this.reactionClick();break;case"go":this.reactionClick();break;default:this.nextTrial()}},b.prototype.reactionClick=function(){if(this.currentClickTime=new Date,Math.abs(this.currentClickTime-this.lastClickTime)<300)return this.getView();switch(this.lastClickTime=this.currentClickTime,console.log("BEFORE: session.reactionClick: ",this.currentTrial.phase),this.currentTrial.reactionClick(),console.log("AFTER: session.reactionClick: ",this.currentTrial.phase),this.currentTrial.phase){case"too-fast":case"too-slow":case"wrong-number":this.correctionTrial=!0,this.currentTrial.include=!1;break;case"result":default:1==this.currentTrial.correct?(console.log(" Including:true  correction:",this.correctionTrial),this.correctionTrial=!1,this.currentTrial.delayPromise=null,console.log("Trials(",this.trials.length,") : ",JSON.stringify(this.trials))):(console.log(" Excluding the trial"),this.correctionTrial=!0)}this.trials.push(this.currentTrial)},b.prototype.getView=function(){return null==this.currentTrial?"splash":this.getValidTrials()>=this.getMaxTrials()?"session-complete":this.currentTrial.phase},b.prototype.getAverage=function(){var a,b,c,d,e;a=0;var f=0;for(e=this.trials,c=0,d=e.length;d>c;c++)b=e[c],1==b.include&&(a+=b.latency,f++);return a/f||0},b.prototype.getValidTrials=function(){for(var a=0,b=0;b<this.trials.length;b++)1==this.trials[b].include&&0==this.trials[b].correction&&(a+=1);return console.log("trialCount:",a),a},b.prototype.getMaxTrials=function(){var a=this.maxTrials;return a},b.prototype.getProblem=function(){var a=0;return this.currentTrial&&this.currentTrial.problem&&(a=this.currentTrial.problem),a},b.prototype.getNumberClass=function(a){return this.currentTrial&&this.currentTrial.answer&&this.currentTrial.answer!=this.getProblem()&&a==this.currentTrial.answer?"number-wrong":a!=this.getProblem()?"number-disabled":"waiting"==this.getView()?"number-disabled":"number-selected"},b.prototype.cancelLastTrial=function(){console.log("Cancel Last Trial");for(var a=this.trials.length-1;a>=0;a--){if(1==this.trials[a].include&&0==this.trials[a].correction){this.trials.pop();break}this.trials.pop()}},b.prototype.endSession=function(){console.log("End Session"),this.initialize()},b.prototype.setMessage=function(a){this.message=a},b.prototype.getMessage=function(){return this.message},b.prototype.saveSession=function(){var a=gauss.Vector,b={};b.trials=new a;var c=this.trials;if(0==c.length)return null;for(var e=0;e<c.length;e++){var f={},g=c[e];f.p=g.problem,f.a=g.answer,f.l=Math.round(g.latency),1==g.include&&(f.n=!0),1==g.correct&&(f.c=!0),1==g.warmup&&(f.w=!0),1==g.correction&&(f.x=!0),b.trials.push(f)}return b.notes="User needs to enter this somewhere.",b.starttime=new Date(c[0].starttime),b.endtime=new Date(c[c.length-1].endtime),b.duration=Math.round((b.endtime-b.starttime)/1e3),b.minlatency=150,b.maxlatency=3e3,b.testtype="A",b.testversion=1,b.delay=Math.round(c[0].delay),console.log("saveSession:",b),this.initialize(),d.addSession(b)},b}()}]),myApp.controller("ReactionTimeCtrl",["$scope","ReactionTimeSession",function(a,b){return a.test=new b,a.test.hello=function(){var b;b.then(function(b){a.test.message=b.message[0],console.log("result.message[0]:",b.message[0]," result:",b)},function(a){console.log("hello status:",a)})},a.test.saveTrials=function(){{var a;this.trials}a.then(function(a){console.log("saveTrials:",a)},function(a){console.log("saveTrials status:",a)})},a.test}]);var overwriteWithout=function(a,b){for(var c=a.length;c>=0;c--)a[c]===b&&a.splice(c,1)},isSet=function(a,b){return _.isUndefined(b)?!1:""===b?!0:a.$eval(b)};myApp.factory("shortcuts",["$document",function(a){var b=[],c={"delete":8,tab:9,enter:13,"return":13,esc:27,space:32,left:37,up:38,right:39,down:40,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},d=function(a,b){for(var d=a.length,e=0;d>e;e++)c[a[e]]=b+e};d("1234567890",49),d("abcdefghijklmnopqrstuvwxyz",65);var e={};_.forEach(c,function(a,b){e[a]=b});var f={shift:"shift",ctrl:"ctrl",meta:"meta",alt:"alt"},g=function(a){var b=a.split("+"),d={};return _.forEach(f,function(a){d[a]=!1}),_.forEach(b,function(a){var b=f[a];if(b)d[b]=!0;else if(d.keyCode=c[a],!d.keyCode)return}),d},h=function(a){var b={};return b.keyCode=c[e[a.which]],b.meta=a.metaKey||!1,b.alt=a.altKey||!1,b.ctrl=a.ctrlKey||!1,b.shift=a.shiftKey||!1,b},i=function(a,b){return a.keyCode===b.keyCode&&a.ctrl===b.ctrl&&a.alt===b.alt&&a.meta===b.meta&&a.shift===b.shift};return a.bind("keydown",function(a){var c=$(a.target);if(!c.is('input[type="text"], textarea'))for(var d,e=h(a),f=b.length-1;f>=0;f--)if(d=b[f],i(e,d.keys))return a.preventDefault(),void d.action()}),{shortcuts:b,register:function(a){return a.keys=g(a.keySet),a.keys?(b.push(a),a):void 0},unregister:function(a){overwriteWithout(b,a)}}}]),myApp.directive("ngShortcut",["$parse","shortcuts",function(a,b){return{restrict:"A",link:function(c,d,e){var f=c.$eval(e.ngShortcut);if(!_.isUndefined(f)){f=f.split("|");var g=_.ignore,h=function(a){return function(){d.trigger(a)}};if(isSet(c,e.ngShortcutClick))g=h("click");else if(isSet(c,e.ngShortcutFocus))g=h("focus");else if(isSet(c,e.ngShortcutFastClick))g=h("click");else if(e.ngShortcutNavigate){var i=c.$eval(e.ngShortcutNavigate);g=function(){navigation.redirect(i,!0)}}else if(e.ngShortcutAction){var j=a(e.ngShortcutAction);g=function(){c.$apply(function(){j(c)})}}_.forEach(f,function(a){var d=b.register({keySet:a,action:g,description:e.ngShortcutDescription||""});c.$on("$destroy",function(){b.unregister(d)})})}}}}]),function(a,b){return"function"==typeof define&&define.amd?void define(["angular"],function(a){return b(a)}):b(a)}(angular||null,function(a){var b=a.module("ngTable",[]);b.factory("ngTableParams",["$q","$log",function(b,c){var d=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},e=function(e,f){var g=this,h=function(){j.debugMode&&c.debug&&c.debug.apply(this,arguments)};this.data=[],this.parameters=function(b,c){if(c=c||!1,a.isDefined(b)){for(var e in b){var f=b[e];if(c&&e.indexOf("[")>=0){for(var g=e.split(/\[(.*)\]/).reverse(),j="",k=0,l=g.length;l>k;k++){var m=g[k];if(""!==m){var n=f;f={},f[j=m]=d(n)?parseFloat(n):n}}"sorting"===j&&(i[j]={}),i[j]=a.extend(i[j]||{},f[j])}else i[e]=d(b[e])?parseFloat(b[e]):b[e]}return h("ngTable: set parameters",i),this}return i},this.settings=function(b){return a.isDefined(b)?(a.isArray(b.data)&&(b.total=b.data.length),j=a.extend(j,b),h("ngTable: set settings",j),this):j},this.page=function(b){return a.isDefined(b)?this.parameters({page:b}):i.page},this.total=function(b){return a.isDefined(b)?this.settings({total:b}):j.total},this.count=function(b){return a.isDefined(b)?this.parameters({count:b,page:1}):i.count},this.filter=function(b){return a.isDefined(b)?this.parameters({filter:b}):i.filter},this.sorting=function(b){if(2==arguments.length){var c={};return c[b]=arguments[1],this.parameters({sorting:c}),this}return a.isDefined(b)?this.parameters({sorting:b}):i.sorting},this.isSortBy=function(b,c){return a.isDefined(i.sorting[b])&&i.sorting[b]==c},this.orderBy=function(){var a=[];for(var b in i.sorting)a.push(("asc"===i.sorting[b]?"+":"-")+b);return a},this.getData=function(b,c){return b.resolve(a.isArray(this.data)&&a.isObject(c)?this.data.slice((c.page()-1)*c.count(),c.page()*c.count()):[]),b.promise},this.getGroups=function(c,d){var e=b.defer();return e.promise.then(function(b){var e={};a.forEach(b,function(b){var c=a.isFunction(d)?d(b):b[d];e[c]=e[c]||{data:[]},e[c].value=c,e[c].data.push(b)});var f=[];for(var g in e)f.push(e[g]);h("ngTable: refresh groups",f),c.resolve(f)}),this.getData(e,g)},this.generatePagesArray=function(a,b,c){var d,e,f,g,h,i;if(d=11,i=[],h=Math.ceil(b/c),h>1){i.push({type:"prev",number:Math.max(1,a-1),active:a>1}),i.push({type:"first",number:1,active:a>1}),f=Math.round((d-5)/2),g=Math.max(2,a-f),e=Math.min(h-1,a+2*f-(a-g)),g=Math.max(2,g-(2*f-(e-g)));for(var j=g;e>=j;)i.push(j===g&&2!==j||j===e&&j!==h-1?{type:"more",active:!1}:{type:"page",number:j,active:a!==j}),j++;i.push({type:"last",number:h,active:a!==h}),i.push({type:"next",number:Math.min(h,a+1),active:h>a})}return i},this.url=function(b){b=b||!1;var c=b?[]:{};for(var d in i)if(i.hasOwnProperty(d)){var e=i[d],f=encodeURIComponent(d);if("object"==typeof e){for(var g in e)if(!a.isUndefined(e[g])&&""!==e[g]){var h=f+"["+encodeURIComponent(g)+"]";b?c.push(h+"="+e[g]):c[h]=e[g]}}else a.isFunction(e)||a.isUndefined(e)||""===e||(b?c.push(f+"="+encodeURIComponent(e)):c[f]=encodeURIComponent(e))}return c},this.reload=function(){var a=b.defer(),c=this,d=null;return j.$loading=!0,d=j.groupBy?j.getGroups(a,j.groupBy,this):j.getData(a,this),h("ngTable: reload data"),d||(d=a.promise),d.then(function(a){return j.$loading=!1,h("ngTable: current scope",j.$scope),j.groupBy?(c.data=a,j.$scope&&(j.$scope.$groups=a)):(c.data=a,j.$scope&&(j.$scope.$data=a)),j.$scope&&(j.$scope.pages=c.generatePagesArray(c.page(),c.total(),c.count())),a})},this.reloadPages=function(){var a=this;j.$scope.pages=a.generatePagesArray(a.page(),a.total(),a.count())};var i=this.$params={page:1,count:1,filter:{},sorting:{},group:{},groupBy:null},j={$scope:null,$loading:!1,data:null,total:0,defaultSort:"desc",filterDelay:750,counts:[10,25,50,100],getGroups:this.getGroups,getData:this.getData};return this.settings(f),this.parameters(e,!0),this};return e}]);var c=["$scope","ngTableParams","$q",function(b,c){b.$loading=!1,b.params||(b.params=new c),b.params.settings().$scope=b;var d=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}();b.$watch("params.$params",function(c,e){b.params.settings().$scope=b,a.equals(c.filter,e.filter)?b.params.reload():d(function(){b.params.reload()},b.params.settings().filterDelay)},!0),b.sortBy=function(a,c){var d=b.parse(a.sortable);if(d){var e=b.params.settings().defaultSort,f="asc"===e?"desc":"asc",g=b.params.sorting()&&b.params.sorting()[d]&&b.params.sorting()[d]===e,h=c.ctrlKey?b.params.sorting():{};h[d]=g?f:e,b.params.parameters({sorting:h})}}}];return b.directive("ngTable",["$compile","$q","$parse",function(b,d,e){return{restrict:"A",priority:1001,scope:!0,controller:c,compile:function(c){var d=[],f=0,g=null,h=c.find("thead");return a.forEach(a.element(c.find("tr")),function(b){b=a.element(b),b.hasClass("ng-table-group")||g||(g=b)}),g?(a.forEach(g.find("td"),function(b){var c=a.element(b);if(!c.attr("ignore-cell")||"true"!==c.attr("ignore-cell")){var g=function(a,b){return function(f){return e(c.attr("x-data-"+a)||c.attr("data-"+a)||c.attr(a))(f,{$columns:d})||b}},h=g("title"," "),i=g("header",!1),j=g("filter",!1)(),k=!1,l=!1;j&&j.$$name&&(l=j.$$name,delete j.$$name),j&&j.templateURL&&(k=j.templateURL,delete j.templateURL),c.attr("data-title-text",h()),d.push({id:f++,title:h,sortable:g("sortable",!1),"class":c.attr("x-data-header-class")||c.attr("data-header-class")||c.attr("header-class"),filter:j,filterTemplateURL:k,filterName:l,headerTemplateURL:i,filterData:c.attr("filter-data")?c.attr("filter-data"):null,show:c.attr("ng-show")?function(a){return e(c.attr("ng-show"))(a)}:function(){return!0}})}}),function(c,f,g){if(c.$loading=!1,c.$columns=d,c.$watch(g.ngTable,function(b){a.isUndefined(b)||(c.paramsModel=e(g.ngTable),c.params=b)},!0),c.parse=function(b){return a.isDefined(b)?b(c):""},g.showFilter&&c.$parent.$watch(g.showFilter,function(a){c.show_filter=a}),a.forEach(d,function(b){var d;if(b.filterData){if(d=e(b.filterData)(c,{$column:b}),!a.isObject(d)||!a.isObject(d.promise))throw new Error("Function "+b.filterData+" must be instance of $q.defer()");return delete b.filterData,d.promise.then(function(c){a.isArray(c)||(c=[]),c.unshift({title:"-",id:""}),b.data=c})}}),!f.hasClass("ng-table")){c.templates={header:g.templateHeader?g.templateHeader:"ng-table/header.html",pagination:g.templatePagination?g.templatePagination:"ng-table/pager.html"};var i=h.length>0?h:a.element(document.createElement("thead")).attr("ng-include","templates.header"),j=a.element(document.createElement("div")).attr("ng-include","templates.pagination");f.find("thead").remove();{f.find("tbody")}return f.prepend(i),b(i)(c),b(j)(c),f.addClass("ng-table"),f.after(j)}}):void 0}}}]),a.module("ngTable").run(["$templateCache",function(a){a.put("ng-table/filters/select-multiple.html",'<select ng-options="data.id as data.title for data in column.data" multiple ng-multiple="true" ng-model="params.filter()[name]" ng-show="filter==\'select-multiple\'" class="filter filter-select-multiple form-control" name="{{column.filterName}}"> </select>'),a.put("ng-table/filters/select.html",'<select ng-options="data.id as data.title for data in column.data" ng-model="params.filter()[name]" ng-show="filter==\'select\'" class="filter filter-select form-control" name="{{column.filterName}}"> </select>'),a.put("ng-table/filters/text.html",'<input type="text" name="{{column.filterName}}" ng-model="params.filter()[name]" ng-if="filter==\'text\'" class="input-filter form-control"/>'),a.put("ng-table/header.html",'<tr> <th ng-repeat="column in $columns" ng-class="{ \'sortable\': parse(column.sortable), \'sort-asc\': params.sorting()[parse(column.sortable)]==\'asc\', \'sort-desc\': params.sorting()[parse(column.sortable)]==\'desc\' }" ng-click="sortBy(column, $event)" ng-show="column.show(this)" ng-init="template=column.headerTemplateURL(this)" class="header {{column.class}}"> <div ng-if="!template" ng-show="!template" ng-bind="parse(column.title)"></div> <div ng-if="template" ng-show="template"><div ng-include="template"></div></div> </th> </tr> <tr ng-show="show_filter" class="ng-table-filters"> <th ng-repeat="column in $columns" ng-show="column.show(this)" class="filter"> <div ng-repeat="(name, filter) in column.filter"> <div ng-if="column.filterTemplateURL" ng-show="column.filterTemplateURL"> <div ng-include="column.filterTemplateURL"></div> </div> <div ng-if="!column.filterTemplateURL" ng-show="!column.filterTemplateURL"> <div ng-include="\'ng-table/filters/\' + filter + \'.html\'"></div> </div> </div> </th> </tr>'),a.put("ng-table/pager.html",'<div class="ng-cloak ng-table-pager"> <div ng-if="params.settings().counts.length" class="ng-table-counts btn-group pull-right"> <button ng-repeat="count in params.settings().counts" type="button" ng-class="{\'active\':params.count()==count}" ng-click="params.count(count)" class="btn btn-default"> <span ng-bind="count"></span> </button> </div> <ul class="pagination ng-table-pagination"> <li ng-class="{\'disabled\': !page.active}" ng-repeat="page in pages" ng-switch="page.type"> <a ng-switch-when="prev" ng-click="params.page(page.number)" href="">&laquo;</a> <a ng-switch-when="first" ng-click="params.page(page.number)" href=""><span ng-bind="page.number"></span></a> <a ng-switch-when="page" ng-click="params.page(page.number)" href=""><span ng-bind="page.number"></span></a> <a ng-switch-when="more" ng-click="params.page(page.number)" href="">&#8230;</a> <a ng-switch-when="last" ng-click="params.page(page.number)" href=""><span ng-bind="page.number"></span></a> <a ng-switch-when="next" ng-click="params.page(page.number)" href="">&raquo;</a> </li> </ul> </div> ')}]),b});